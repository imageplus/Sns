# Imageplus SNS
Handles SNS interactions

## Installation
To install the page run
```
composer require imageplus/sns
```

---

### Publishing Required Files
The package contains both a config file and migrations which need to be published for the package to function correctly. 

*The config must be published before the migrations have run*

#### Publishing The Config
To publish the config file run
```
php artisan vendor:publish --tag=config
```
#### Publishing The Migrations
To publish the migrations run
```
php artisan vendor:publish --tag=migrations
```

---

### Basic Configuration
The config has a lot of default values to make configuration easier

#### Routes
The default routes available within the package allow apps to register and unregister themselves to receive notifications

To add these routes to your application add the below to the `Boot` method of your `app\Providers\RouteServiceProvider`
```php
Sns::routes()
```

It's possible to pass an array to `Sns::routes()`. This array should contain any valid parameter for a `Route::group()` the defaults for this are below.
```php
[
    'prefix' => '/sns',
    'middleware' => ['auth:api'],
    'as' => 'sns.'
]
```

#### Access Keys
Access keys are required to interact with SNS. You will need to add the below to your environment file to set the access keys
```dotenv
SNS_KEY=
SNS_SECRET=
SNS_REGION=eu-west-1 #Optional -> default is eu-west-1
SNS_VERSION=latest   #Optional -> default is latest
```

#### Platform ARNs
Platform ARNs are required for any device type you want to be able to register for use with SNS notifications

By default the package has device types configured for `android` and `ios`. To make use of these you'll need to add the below to your environment file
```dotenv
ANDROID_PLATFORM_ARN=
IOS_PLATFORM_ARN=
```

To add additional device types see the sns config files `platform_arns` array
```php
'platform_arns' => [
    'android' => env('ANDROID_PLATFORM_ARN', ''),
    'ios' => env('IOS_PLATFORM_ARN', ''),
]
```

### Other Configuration Settings

#### Topic Tags
Tags can be added to all topics using the configuration file.

Inside the configuration file the `topic_tags` item needs to be used for this. For a valid configuration see the `Tags` array at [Amazon SNS](https://docs.aws.amazon.com/aws-sdk-php/v3/api/api-sns-2010-03-31.html#tagresource)

#### Topic Prefix
Topic prefixes are prepended to all topics generated by the package or its methods.

These prefixes are added using an environment variable but has a default of `APP_NAME`
```dotenv
SNS_TOPIC_PREFIX=
```

---

### Basic Setup
By default the package is not configured with any topics and if a device is registered it will only create the endpoint and not assign it to any topics.

#### Creating Topics
The package registers the below command to allow you to create topics within SNS and add them to the database.
```
sns:create-topics
```

If you only want to create a single topic add the `once` flag like below
```
sns:create-topics --once
```

#### Subscribing To Topics
A device can be subscribed to any number of topics. These must be created prior to device registration.

To define which devices are subscribed to which topics pass a callback to `Sns::assignEndpointToTopics()` if you don't want to subscribe to any topics pass false instead of a callback

The way in which these are defined is an associative array. *Example Below*

```php
Sns::assignEndpointToTopics(function(Model $model, SnsEndpointContract $endpoint){
    return [ 
        'topic_1' => [
            'attribute_1' => ['value_1', 'value_2']
        ],
        'topic_2' => [],
        'topic_3' => []
    ];
});
```

**Keys**: These must be mappable to an `SnsTopic` model instance via either an `id`, `name` or `topic arn`.

**Values**: These must be a valid `Filter Policy` (see [Amazon SNS](https://docs.aws.amazon.com/sns/latest/dg/example-filter-policies.html)) in Array format

**DUE TO CURRENT LIMITATIONS OF AWS SUBSCRIPTION FILTER POLICIES ONLY USE EMPTY ARRAYS AS THE VALUES**

---

## Usage

### Sending Messages
Sending messages is handled by the `SnsMessageHandler` and is called via the `Sns::message()` method

All messages called up until `send` can be called in any order and are chainable

>**Set Message Attributes**
>
> This method is used to define the attributes used to validate the filter policy attached to each subscription attaching the device to a topic.
> 
> The attributes given must be a valid `FilterPolicy` (see [Amazon SNS](https://docs.aws.amazon.com/sns/latest/dg/example-filter-policies.html))
> 
> *For this to work all attributes present on a subscription you're trying to send to must be given as an attribute*
> 
> **Method**: `setMessageAttributes(Array $attributes)`
> 
> **Example**
> ```php
> $message->setMessageAttributes([
>   'device_platform' => [
>       'Name'        => 'device_platform',
>       'DataType'    => 'String',
>       'StringValue' => 'ios'
>   ] 
> ])
> ```

>**Set Message Content**
> 
> This method is used to set the content sent to the different devices within the notification
> 
> **Method**: `setMessageContent(string $title, string $message)`
> 
> **Example**: 
> ```php
> $message->setMessageContent('Notification Title', 'Notification Body')
> ```

>**Set Additional Data**
> 
> This method should be used to send any additional data to the recipient of the notification
> 
> *This method isn't required if you don't need additional data with a notification*
> 
> **Method** `setAdditionalData(array $additionalData)`
> 
> **Example** 
> ```php
> $message->setAdditionalData(['model_id' => 1])
> ```

>**Target Device Type**
> 
> To only send device specific content to certain devices this method should be passed the device types you want to add device specific content to
> 
> *This method isn't required as all devices configured in the config option `default_messages` are used as default*
> 
> **Method**: `targetDeviceType(SnsDefaultApnMessageContract|SnsDefaultApnMessageContract[] $deviceType)`
> 
> **Example**: 
> ```php
> $message->targetDeviceType(\Imageplus\Sns\DefaultMessages\Apns::class)
> ```

>**Set Message Type**
> 
> Acts as an identifier for the app sending notifications
> 
> *This is not required and defaults to `APP_NAME Notifications`*
> 
> **Method**: `setMessageType(string $messageType)`
> 
> **Example** 
> ```php
> $message->setMessageType('App Update Notification')
> ```

>**Send Message**
> 
> This method handles building and sending the final notification
> 
> *This method is the only one which isn't chainable as it returns a boolean depending on success of the notification*
> 
> TODO: TEST STRUCTURE
> 
> **Method**: `send(string $topic_arn, string $subject, string $structure = 'json')`
> 
> **Example**: 
> ```php
> $message->send('arn:aws:sns:eu-west-1:123:arn', 'App Update')
> ```

### Handling Topics

#### Creating Topics

You can register topics using the command defined above in basic setup or by the function `Sns::findOrCreateTopic`

This method will either create a new topic and register it with SNS or return an existing one
 
*Sns will return an existing topic if you attempt to create one with the same name so calling this from a seeder won't cause duplications*

> **Method**: `findOrCreateTopic(string $name)`
>
> **Example**:
> ```php
> Sns::findOrCreateTopic('app-updates')
> ```

### Handling Subscriptions

#### Removing Subscriptions From Topics

You can unsubscribe devices from individual topics

*This method will accept either a subscription arn, or an SnsTopicSubscriptions model instance*

> **Method**: `unsubscribeFromTopic($value)`
>
> **Example**:
> ```php
> Sns::unsubscribeFromTopic('arn:aws:sns:eu-west-1:123456:topic-name:63eafde6-e965-474e-8e32-9352a4f28ed')
> ```


### Registering and Unregistering From an App

This will only work as shown below if the default package controller and routes are used

#### Registering a device

>**Route**: `{base-url}/api/sns/register-device`
>
>**Method**: `POST`
>
>**Parameters**:
>
>```json
>{
>    "device_token": "device token",
>    "platform"    : "ios|android"
>}
>```

#### Unregistering a device

>**Route**: `{base-url}/api/sns/unregister-device`
>
>**Method**: `POST`
>
>**Parameters**:
>
>```json
>{
>    "device_token": "device token",
>    "platform"    : "ios|android"
>}
>```

